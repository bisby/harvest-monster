import { get } from "svelte/store";
import { crafts, settings } from "../stores";
import { formatPrice } from "./formatPrice";
import { parsePrice } from "./parsePrice";

let leagues = {
  std: "Standard",
  lsc: "Sentinel Softcore",
  lhc: "Sentinel Hardcore",
};

const formatter = {
  prefix: ({ currentLeagueName, username, customNotes, willingToStream }) => {
    let post = "";

    post += `**WTS ${currentLeagueName}**`;

    if (username && username.trim() !== "") {
      post += ` - IGN: **${username}**`;
    }

    post += ` \`| generated by HarvestMonster\``;

    post += `\n`;

    // Custom Notes
    if (customNotes.trim() !== "") {
      post += `${customNotes}\n`;
    }

    // Willing to Stream
    if (willingToStream) {
      post += `   *Can stream if requested*\n`;
    }

    return post;
  },
  craft: (craft, { maxCraftLength }) => {
    let post = "";
    const quantityLengthAdjustment = `${craft.quantity}`.length - 1;
    let bufferLength =
      maxCraftLength - craft.name.length + 4 - quantityLengthAdjustment;

    const buffer = Array.from(Array(bufferLength), () => "").join(" ");

    post += "   ";

    if (craft.quantity === 0) {
      post += "~~";
    }

    post += `\`${craft.quantity}x ${craft.name}${buffer} [${
      craft.level > 0 ? craft.level : "83"
    }]  <${formatPrice(parsePrice(craft.displayPrice))}>\``;

    if (craft.quantity === 0) {
      post += "~~";
    }

    post += "\n";

    return post;
  },
  suffix: () => "",
};

export const formatPost = () => {
  const currentCrafts = get(crafts);
  const currentSettings = get(settings);
  const formatterSettings = {
    currentLeagueName: leagues[currentSettings.league.code],
    maxCraftLength: [...currentCrafts].sort((a, b) =>
      b.name.length > a.name.length ? 1 : -1
    )[0].name.length,
    ...currentSettings,
  };
  let post = "";

  post += formatter.prefix(formatterSettings);

  for (let craft of currentCrafts) {
    post += formatter.craft(craft, formatterSettings);
  }

  post += formatter.suffix(formatterSettings);

  return post;
};
